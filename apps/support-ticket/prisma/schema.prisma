// apps/support-service/prisma/schema.prisma

generator client {
    provider = "prisma-client-js"
    output   = "./generated/client"
}

datasource db {
    provider = "postgresql"
    url      = env("SUPPORT_TICKET_DATABASE_URL")
}

model Ticket {
    id              String         @id @default(cuid())
    orgId           String
    ticketNo        String         @unique
    title           String
    description     String
    createdByUserId String
    assigneeUserId  String?
    status          TicketStatus   @default(OPEN)
    priority        TicketPriority @default(MEDIUM)
    type            TicketType
    locked          Boolean        @default(false)
    createdAt       DateTime       @default(now())
    updatedAt       DateTime       @updatedAt

    history  TicketActivity[]
    comments Comment[]

    @@index(orgId)
    @@index([orgId, id])
    @@index([orgId, status])
    @@index([orgId, assigneeUserId])
    @@map("tickets")
}

model TicketActivity {
    id          String   @id @default(cuid())
    ticketId    String
    orgId       String
    type        String // "created", "assigned", "status_changed", "priority_changed", "comment_added"
    actorUserId String // who performed the action
    meta        Json // flexible field to store details (from/to values, body, assignee, etc.)
    createdAt   DateTime @default(now())

    ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

    @@index([orgId, ticketId])
    @@map("ticket_activities")
}

model Comment {
    id           String   @id @default(cuid())
    ticketId     String
    orgId        String
    authorUserId String
    body         String
    createdAt    DateTime @default(now())

    ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

    @@index([orgId, ticketId])
    @@map("comments")
}

model TicketCounter {
    id        Int    @id @default(autoincrement())
    orgId     String
    yearMonth String
    counter   Int    @default(0)

    @@unique([orgId, yearMonth])
}

enum TicketStatus {
    OPEN
    IN_PROGRESS
    ON_HOLD
    CANCELLED
    RESOLVED
    CLOSED
}

enum TicketPriority {
    LOW
    MEDIUM
    HIGH
}

enum TicketType {
    INCIDENT
    BUG
    FEATURE
}
